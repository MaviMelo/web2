<?php
/**
 * controlador BorrowingController implementa as funções necessárias para registrar empréstimos e devoluções de livros.
 */

namespace App\Http\Controllers;

use App\Models\Book;
use App\Models\Borrowing;
use App\Models\User;
use Illuminate\Http\Request;
use App\Policies\BorrowingPolicy;

class BorrowingController extends Controller
{
    public function store(Request $request, Book $book)
    {

        // dd( auth()->user(), $request->all(), $book );

        if (! in_array(auth()->user()->role, ['admin', 'librarian'])) {
            abort(403, 'Acesso não autorizado. Apenas funcionários.');
        }

        $request->validate([
            'user_id' => 'required|exists:users,id',
        ]);

        if (Borrowing::where('user_id', $request->user_id)->whereNull('returned_at')->exists()) {
       echo '<script>alert("Usuário tem devolução de livro(s) pendente(s)! Não é permitido novos empréstimos. Veja as pendências do usuário."); window.history.back();</script>';
        exit;
        };

        Borrowing::create([
            'user_id' => $request->user_id,
            'book_id' => $book->id,
            'borrowed_at' => now(),
        ]);

        return redirect()->route('books.show', $book)->with('success', 'Empréstimo
registrado com sucesso.');
    }


    public function returnBook(Borrowing $borrowing)
    {
        if (! in_array(auth()->user()->role, ['admin', 'librarian'])) {
            abort(403, 'Acesso não autorizado. Apenas funcionários.');
        }

        $borrowing->update(['returned_at' => now(),
        ]);

        return redirect()->route('books.show', $borrowing->book_id)->with('success', 'Devolução registrada com sucesso.');
    }

    public function userBorrowings(User $user)
    {
        $borrowings = $user->books()->withPivot('borrowed_at', 'returned_at')->get();

        return view('users.borrowings', compact('user', 'borrowings'));
    }

}
